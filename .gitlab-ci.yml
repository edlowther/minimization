default:
  image: python:3.11-slim
  cache:
    paths:
        - .cache/pip
  before_script: 
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
    - git config --global user.name edlowther
    - git config --global user.email 21758142-edlowther@users.noreply.gitlab.com
    - git remote set-url origin https://edlowther:$ACCESS_TOKEN@gitlab.com/edlowther/minimization
    - git checkout -b gitlab

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

initialize-project:
  only:
    changes:
      - initialize-project.yaml
  variables:
    GIT_STRATEGY: clone
  script:
    - python initialize.py
    - if [ -f demo/chart* ] ; then
    -   git rm demo/chart*
    - fi
    - python demo/sensitivity-analysis.py ${CI_COMMIT_SHA:0:8}
    - git status
    - git add demo/sensitivity-analysis.md
    - if [ -f demo/chart* ] ; then
    -   git add demo/chart*
    - fi
    - git commit -m "Update sensitivity analysis charts"
    - git add allocations.csv new-participant-data.yaml
    - git rm initialize-project.yaml
    - git commit -m "Prevent project being initialized more than once"
    - git push origin gitlab -o ci.skip

add-new-participant-to-existing-trial:
  only: 
    changes: 
      - new-participant-data.yaml
  variables: 
    GIT_STRATEGY: clone
  script:
    - if [ -f chart* ] ; then
    -   git rm chart*
    - fi
    - python main.py ${CI_COMMIT_SHA:0:8}
    - git status
    - git add README.md allocations.csv 
    - if [ -f chart* ] ; then
    -   git add chart*
    - fi
    - git commit -m "Add new trial participant"
    - git push origin gitlab
